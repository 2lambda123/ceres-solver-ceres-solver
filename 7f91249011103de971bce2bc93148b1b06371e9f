{
  "comments": [
    {
      "unresolved": false,
      "key": {
        "uuid": "57fc31df_49739f09",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 6141
      },
      "writtenOn": "2022-11-13T18:57:41Z",
      "side": 1,
      "message": "Added parallel left products to partitioned matrix view.\n\nResults for E part are greater because of the order of residual blocks (next cell in column-block is located at a constant offset from the current one).\n\nFor F part there is a huge performance gap between 1 and 2 threads (both with/without \"fair\" partitioning); I haven\u0027t investigated it yet.\n\nThere also seem to be a limit because of lack of parallelization somewhere else: when running bundle_adjuster with 28 threads I get quite small average CPU load (about 300%).\n\n\nIn my experiments left products for partitioned view do not have large impact on the whole runtime of optimization.\n\n```\n2022-11-13T15:56:08+03:00\nRunning ./bin/evaluation_benchmark\nRun on (112 X 2242.73 MHz CPU s)\nCPU Caches:\n  L1 Data 32 KiB (x56)\n  L1 Instruction 32 KiB (x56)\n  L2 Unified 1024 KiB (x56)\n  L3 Unified 39424 KiB (x2)\nLoad Average: 10.09, 7.89, 9.90\n--------------------------------------------------------------------------------------------------------------------------------------\nBenchmark                                                                                                            Time   Iterations\n--------------------------------------------------------------------------------------------------------------------------------------\nJacobianPartitionedLeftMultiplyAndAccumulateF\u003cfinal/problem-13682-4456117-pre.txt\u003e/1_median                       587 ms           10\nJacobianPartitionedLeftMultiplyAndAccumulateWithTransposeF\u003cfinal/problem-13682-4456117-pre.txt\u003e/1_median          590 ms           10\nJacobianPartitionedLeftMultiplyAndAccumulateWithTransposeF\u003cfinal/problem-13682-4456117-pre.txt\u003e/2_median         1631 ms           10\nJacobianPartitionedLeftMultiplyAndAccumulateWithTransposeF\u003cfinal/problem-13682-4456117-pre.txt\u003e/4_median          849 ms           10\nJacobianPartitionedLeftMultiplyAndAccumulateWithTransposeF\u003cfinal/problem-13682-4456117-pre.txt\u003e/8_median          450 ms           10\nJacobianPartitionedLeftMultiplyAndAccumulateWithTransposeF\u003cfinal/problem-13682-4456117-pre.txt\u003e/16_median         249 ms           10\nJacobianPartitionedLeftMultiplyAndAccumulateWithTransposeF\u003cfinal/problem-13682-4456117-pre.txt\u003e/28_median         234 ms           10\n\nJacobianPartitionedLeftMultiplyAndAccumulateE\u003cfinal/problem-13682-4456117-pre.txt\u003e/1_median                       310 ms           10\nJacobianPartitionedLeftMultiplyAndAccumulateWithTransposeE\u003cfinal/problem-13682-4456117-pre.txt\u003e/1_median          313 ms           10\nJacobianPartitionedLeftMultiplyAndAccumulateWithTransposeE\u003cfinal/problem-13682-4456117-pre.txt\u003e/2_median         99.8 ms           10\nJacobianPartitionedLeftMultiplyAndAccumulateWithTransposeE\u003cfinal/problem-13682-4456117-pre.txt\u003e/4_median         52.9 ms           10\nJacobianPartitionedLeftMultiplyAndAccumulateWithTransposeE\u003cfinal/problem-13682-4456117-pre.txt\u003e/8_median         29.6 ms           10\nJacobianPartitionedLeftMultiplyAndAccumulateWithTransposeE\u003cfinal/problem-13682-4456117-pre.txt\u003e/16_median        21.1 ms           10\nJacobianPartitionedLeftMultiplyAndAccumulateWithTransposeE\u003cfinal/problem-13682-4456117-pre.txt\u003e/28_median        20.7 ms           10\n\n\n--------------------------------------------------------------------------------------------------------------------------------------\n\nJacobianPartitionedLeftMultiplyAndAccumulateF\u003cvenice/problem-1778-993923-pre.txt\u003e/1_median                       93.8 ms           10\nJacobianPartitionedLeftMultiplyAndAccumulateWithTransposeF\u003cvenice/problem-1778-993923-pre.txt\u003e/1_median          92.6 ms           10\nJacobianPartitionedLeftMultiplyAndAccumulateWithTransposeF\u003cvenice/problem-1778-993923-pre.txt\u003e/2_median           237 ms           10\nJacobianPartitionedLeftMultiplyAndAccumulateWithTransposeF\u003cvenice/problem-1778-993923-pre.txt\u003e/4_median           126 ms           10\nJacobianPartitionedLeftMultiplyAndAccumulateWithTransposeF\u003cvenice/problem-1778-993923-pre.txt\u003e/8_median          66.6 ms           10\nJacobianPartitionedLeftMultiplyAndAccumulateWithTransposeF\u003cvenice/problem-1778-993923-pre.txt\u003e/16_median         38.7 ms           10\nJacobianPartitionedLeftMultiplyAndAccumulateWithTransposeF\u003cvenice/problem-1778-993923-pre.txt\u003e/28_median         35.3 ms           10\n\nJacobianPartitionedLeftMultiplyAndAccumulateE\u003cvenice/problem-1778-993923-pre.txt\u003e/1_median                       50.6 ms           10\nJacobianPartitionedLeftMultiplyAndAccumulateWithTransposeE\u003cvenice/problem-1778-993923-pre.txt\u003e/1_median          51.7 ms           10\nJacobianPartitionedLeftMultiplyAndAccumulateWithTransposeE\u003cvenice/problem-1778-993923-pre.txt\u003e/2_median          17.3 ms           10\nJacobianPartitionedLeftMultiplyAndAccumulateWithTransposeE\u003cvenice/problem-1778-993923-pre.txt\u003e/4_median          9.47 ms           10\nJacobianPartitionedLeftMultiplyAndAccumulateWithTransposeE\u003cvenice/problem-1778-993923-pre.txt\u003e/8_median          5.59 ms           10\nJacobianPartitionedLeftMultiplyAndAccumulateWithTransposeE\u003cvenice/problem-1778-993923-pre.txt\u003e/16_median         4.39 ms           10\nJacobianPartitionedLeftMultiplyAndAccumulateWithTransposeE\u003cvenice/problem-1778-993923-pre.txt\u003e/28_median         4.51 ms           10\n\n--------------------------------------------------------------------------------------------------------------------------------------\n\nJacobianPartitionedLeftMultiplyAndAccumulateF\u003cladybug/problem-1723-156502-pre.txt\u003e/1_median                      12.0 ms           10\nJacobianPartitionedLeftMultiplyAndAccumulateWithTransposeF\u003cladybug/problem-1723-156502-pre.txt\u003e/1_median         12.0 ms           10\nJacobianPartitionedLeftMultiplyAndAccumulateWithTransposeF\u003cladybug/problem-1723-156502-pre.txt\u003e/2_median         26.7 ms           10\nJacobianPartitionedLeftMultiplyAndAccumulateWithTransposeF\u003cladybug/problem-1723-156502-pre.txt\u003e/4_median         13.8 ms           10\nJacobianPartitionedLeftMultiplyAndAccumulateWithTransposeF\u003cladybug/problem-1723-156502-pre.txt\u003e/8_median         7.80 ms           10\nJacobianPartitionedLeftMultiplyAndAccumulateWithTransposeF\u003cladybug/problem-1723-156502-pre.txt\u003e/16_median        4.14 ms           10\nJacobianPartitionedLeftMultiplyAndAccumulateWithTransposeF\u003cladybug/problem-1723-156502-pre.txt\u003e/28_median        3.76 ms           10\n\nJacobianPartitionedLeftMultiplyAndAccumulateE\u003cladybug/problem-1723-156502-pre.txt\u003e/1_median                      6.86 ms           10\nJacobianPartitionedLeftMultiplyAndAccumulateWithTransposeE\u003cladybug/problem-1723-156502-pre.txt\u003e/1_median         6.80 ms           10\nJacobianPartitionedLeftMultiplyAndAccumulateWithTransposeE\u003cladybug/problem-1723-156502-pre.txt\u003e/2_median         2.05 ms           10\nJacobianPartitionedLeftMultiplyAndAccumulateWithTransposeE\u003cladybug/problem-1723-156502-pre.txt\u003e/4_median         1.15 ms           10\nJacobianPartitionedLeftMultiplyAndAccumulateWithTransposeE\u003cladybug/problem-1723-156502-pre.txt\u003e/8_median        0.718 ms           10\nJacobianPartitionedLeftMultiplyAndAccumulateWithTransposeE\u003cladybug/problem-1723-156502-pre.txt\u003e/16_median       0.573 ms           10\nJacobianPartitionedLeftMultiplyAndAccumulateWithTransposeE\u003cladybug/problem-1723-156502-pre.txt\u003e/28_median       0.733 ms           10\n\n--------------------------------------------------------------------------------------------------------------------------------------\n\nJacobianPartitionedLeftMultiplyAndAccumulateF\u003cdubrovnik/problem-356-226730-pre.txt\u003e/1_median                     22.0 ms           10\nJacobianPartitionedLeftMultiplyAndAccumulateWithTransposeF\u003cdubrovnik/problem-356-226730-pre.txt\u003e/1_median        23.3 ms           10\nJacobianPartitionedLeftMultiplyAndAccumulateWithTransposeF\u003cdubrovnik/problem-356-226730-pre.txt\u003e/2_median        55.7 ms           10\nJacobianPartitionedLeftMultiplyAndAccumulateWithTransposeF\u003cdubrovnik/problem-356-226730-pre.txt\u003e/4_median        30.6 ms           10\nJacobianPartitionedLeftMultiplyAndAccumulateWithTransposeF\u003cdubrovnik/problem-356-226730-pre.txt\u003e/8_median        15.9 ms           10\nJacobianPartitionedLeftMultiplyAndAccumulateWithTransposeF\u003cdubrovnik/problem-356-226730-pre.txt\u003e/16_median       8.59 ms           10\nJacobianPartitionedLeftMultiplyAndAccumulateWithTransposeF\u003cdubrovnik/problem-356-226730-pre.txt\u003e/28_median       7.99 ms           10\n\nJacobianPartitionedLeftMultiplyAndAccumulateE\u003cdubrovnik/problem-356-226730-pre.txt\u003e/1_median                     12.9 ms           10\nJacobianPartitionedLeftMultiplyAndAccumulateWithTransposeE\u003cdubrovnik/problem-356-226730-pre.txt\u003e/1_median        12.3 ms           10\nJacobianPartitionedLeftMultiplyAndAccumulateWithTransposeE\u003cdubrovnik/problem-356-226730-pre.txt\u003e/2_median        3.72 ms           10\nJacobianPartitionedLeftMultiplyAndAccumulateWithTransposeE\u003cdubrovnik/problem-356-226730-pre.txt\u003e/4_median        2.07 ms           10\nJacobianPartitionedLeftMultiplyAndAccumulateWithTransposeE\u003cdubrovnik/problem-356-226730-pre.txt\u003e/8_median        1.23 ms           10\nJacobianPartitionedLeftMultiplyAndAccumulateWithTransposeE\u003cdubrovnik/problem-356-226730-pre.txt\u003e/16_median       1.00 ms           10\nJacobianPartitionedLeftMultiplyAndAccumulateWithTransposeE\u003cdubrovnik/problem-356-226730-pre.txt\u003e/28_median       1.19 ms           10\n\n--------------------------------------------------------------------------------------------------------------------------------------\n\nJacobianPartitionedLeftMultiplyAndAccumulateF\u003ctrafalgar/problem-257-65132-pre.txt\u003e/1_median                      3.75 ms           10\nJacobianPartitionedLeftMultiplyAndAccumulateWithTransposeF\u003ctrafalgar/problem-257-65132-pre.txt\u003e/1_median         3.70 ms           10\nJacobianPartitionedLeftMultiplyAndAccumulateWithTransposeF\u003ctrafalgar/problem-257-65132-pre.txt\u003e/2_median         4.42 ms           10\nJacobianPartitionedLeftMultiplyAndAccumulateWithTransposeF\u003ctrafalgar/problem-257-65132-pre.txt\u003e/4_median         2.43 ms           10\nJacobianPartitionedLeftMultiplyAndAccumulateWithTransposeF\u003ctrafalgar/problem-257-65132-pre.txt\u003e/8_median         1.61 ms           10\nJacobianPartitionedLeftMultiplyAndAccumulateWithTransposeF\u003ctrafalgar/problem-257-65132-pre.txt\u003e/16_median        1.06 ms           10\nJacobianPartitionedLeftMultiplyAndAccumulateWithTransposeF\u003ctrafalgar/problem-257-65132-pre.txt\u003e/28_median        1.09 ms           10\n\nJacobianPartitionedLeftMultiplyAndAccumulateE\u003ctrafalgar/problem-257-65132-pre.txt\u003e/1_median                      1.79 ms           10\nJacobianPartitionedLeftMultiplyAndAccumulateWithTransposeE\u003ctrafalgar/problem-257-65132-pre.txt\u003e/1_median         1.76 ms           10\nJacobianPartitionedLeftMultiplyAndAccumulateWithTransposeE\u003ctrafalgar/problem-257-65132-pre.txt\u003e/2_median        0.565 ms           10\nJacobianPartitionedLeftMultiplyAndAccumulateWithTransposeE\u003ctrafalgar/problem-257-65132-pre.txt\u003e/4_median        0.372 ms           10\nJacobianPartitionedLeftMultiplyAndAccumulateWithTransposeE\u003ctrafalgar/problem-257-65132-pre.txt\u003e/8_median        0.260 ms           10\nJacobianPartitionedLeftMultiplyAndAccumulateWithTransposeE\u003ctrafalgar/problem-257-65132-pre.txt\u003e/16_median       0.262 ms           10\nJacobianPartitionedLeftMultiplyAndAccumulateWithTransposeE\u003ctrafalgar/problem-257-65132-pre.txt\u003e/28_median       0.443 ms           10\n\n--------------------------------------------------------------------------------------------------------------------------------------\n```",
      "revId": "7f91249011103de971bce2bc93148b1b06371e9f",
      "serverId": "cdcfcfbe-2044-3b1f-b5d4-da77ad542329"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "8b68269f_b372c64a",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 5002
      },
      "writtenOn": "2022-11-13T21:28:40Z",
      "side": 1,
      "message": "I am pretty sure the left multiply has a bug. I need to look at it more carefully but on multiple problems it is giving completely different results than when not threaded.\n\nThe reason you can\u0027t see the threading improvements with bundle_adjuster.cc is because the threaded left multiply is not getting called.\n\nthis is because the transpose_block_structure never got added to the matrix.\n\niterative_schur_complement_solver.cc needs to have \n\n```\n if (options_.num_threads \u003e 1) {\n    A-\u003eAddTransposeBlockStructure();\n }\n```\n\nat the top of SolveImpl",
      "revId": "7f91249011103de971bce2bc93148b1b06371e9f",
      "serverId": "cdcfcfbe-2044-3b1f-b5d4-da77ad542329"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "7e9ae901_9ed17d4b",
        "filename": "internal/ceres/evaluation_benchmark.cc",
        "patchSetId": 1
      },
      "lineNbr": 246,
      "author": {
        "id": 5002
      },
      "writtenOn": "2022-11-13T21:28:40Z",
      "side": 1,
      "message": "This can perhaps be made shorter JacobianPartitioned -\u003e PMV",
      "range": {
        "startLine": 246,
        "startChar": 12,
        "endLine": 246,
        "endChar": 58
      },
      "revId": "7f91249011103de971bce2bc93148b1b06371e9f",
      "serverId": "cdcfcfbe-2044-3b1f-b5d4-da77ad542329"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "49e89d81_8289e6c3",
        "filename": "internal/ceres/partitioned_matrix_view_impl.h",
        "patchSetId": 1
      },
      "lineNbr": 218,
      "author": {
        "id": 5002
      },
      "writtenOn": "2022-11-13T21:28:40Z",
      "side": 1,
      "message": "where do you make sure that the matrix actually has a transpose? I mean where in the calling code does a transpose_block_structure gets added to this matrix?",
      "range": {
        "startLine": 218,
        "startChar": 22,
        "endLine": 218,
        "endChar": 29
      },
      "revId": "7f91249011103de971bce2bc93148b1b06371e9f",
      "serverId": "cdcfcfbe-2044-3b1f-b5d4-da77ad542329"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "2d9ab9c3_d406de9d",
        "filename": "internal/ceres/partitioned_matrix_view_impl.h",
        "patchSetId": 1
      },
      "lineNbr": 223,
      "author": {
        "id": 5002
      },
      "writtenOn": "2022-11-13T21:28:40Z",
      "side": 1,
      "message": "should\u0027t this check on num_row_blocks_e_ come before the transpose_bs for an early exit?\n\nalso shouldn\u0027t both these checks be in the single threaded code too?",
      "range": {
        "startLine": 223,
        "startChar": 7,
        "endLine": 223,
        "endChar": 24
      },
      "revId": "7f91249011103de971bce2bc93148b1b06371e9f",
      "serverId": "cdcfcfbe-2044-3b1f-b5d4-da77ad542329"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "9dccdcd6_67726a05",
        "filename": "internal/ceres/partitioned_matrix_view_impl.h",
        "patchSetId": 1
      },
      "lineNbr": 227,
      "author": {
        "id": 5002
      },
      "writtenOn": "2022-11-13T21:28:40Z",
      "side": 1,
      "message": "is this local variable created just for the lambda capture? if so this is worth documenting.",
      "range": {
        "startLine": 227,
        "startChar": 12,
        "endLine": 227,
        "endChar": 28
      },
      "revId": "7f91249011103de971bce2bc93148b1b06371e9f",
      "serverId": "cdcfcfbe-2044-3b1f-b5d4-da77ad542329"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "11429e12_a2fb3ee8",
        "filename": "internal/ceres/partitioned_matrix_view_impl.h",
        "patchSetId": 1
      },
      "lineNbr": 314,
      "author": {
        "id": 5002
      },
      "writtenOn": "2022-11-13T21:28:40Z",
      "side": 1,
      "message": "same comment as above.",
      "revId": "7f91249011103de971bce2bc93148b1b06371e9f",
      "serverId": "cdcfcfbe-2044-3b1f-b5d4-da77ad542329"
    }
  ]
}